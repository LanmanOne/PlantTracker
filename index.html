<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Logan's Garden Vault</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #5d8a5d; --bg: #f0f4f0; --card: #ffffff;
            --text: #2d3e2d; --border: #ddd; --blue: #4a90e2; --dark-blue: #357abd;
            --gauge-red: #ff4d4d; --gauge-green: #4caf50; --gauge-blue: #2196f3;
            --trend-fast: #ef4444; --trend-slow: #10b981;
        }

        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1200px; margin: auto; padding-bottom: 120px; }
        
        .header { padding: 15px 10px; position: sticky; top: 0; background: var(--bg); z-index: 100; border-bottom: 1px solid #e2e8f0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.6rem; color: #3e5c3e; font-weight: 800; }
        
        .filter-row { display: flex; gap: 10px; margin-bottom: 15px; }
        #search-bar { flex: 2; padding: 12px 15px; border-radius: 25px; border: 1px solid var(--border); font-size: 1rem; outline: none; }
        #room-filter { flex: 1; padding: 0 15px; border-radius: 25px; border: 1px solid var(--border); font-size: 0.9rem; background: white; outline: none; }

        #plant-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding: 10px; }
        .plant-card { background: var(--card); border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 12px; position: relative; border-left: 5px solid transparent; }
        .card-dry { border-left-color: var(--gauge-red); background: #fff9f9; }

        .card-top { display: grid; grid-template-columns: 80px 1fr; gap: 15px; align-items: flex-start; }
        .photo-box { width: 80px; height: 80px; border: 2px dashed #a8c6a8; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #fafafa; cursor: pointer; position: relative; }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .photo-label { font-size: 0.6rem; font-weight: bold; color: #888; z-index: 1; }

        .moisture-wrap { background: #f9f9f9; padding: 8px; border-radius: 8px; border: 1px solid #eee; }
        .moisture-controls { display: flex; align-items: center; gap: 8px; }
        
        .trend-icon { font-size: 0.9rem; font-weight: bold; margin-left: 5px; }
        .trend-fast { color: var(--trend-fast); }
        .trend-slow { color: var(--trend-slow); }

        .unlock-btn { width: 34px; height: 34px; border-radius: 50%; border: 1px solid #ccc; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .gauge-slider { flex-grow: 1; height: 8px; border-radius: 5px; -webkit-appearance: none; appearance: none; background: #ddd; opacity: 0.4; pointer-events: none; }
        .gauge-slider.unlocked { opacity: 1; pointer-events: auto; }

        .badge-ai { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; font-size: 0.65rem; padding: 4px 8px; border-radius: 6px; font-weight: bold; }
        .location-input { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; color: #888; border: none; background: transparent; outline: none; width: 100%; font-weight: bold; }
        .name-input { font-size: 1rem; font-weight: bold; border: none; background: transparent; outline: none; width: 100%; margin-bottom: 5px; }

        .water-btn-wrap { position: relative; width: 130px; height: 38px; overflow: hidden; border-radius: 8px; background: var(--blue); }
        .water-btn { position: relative; z-index: 2; width: 100%; height: 100%; background: transparent; color: white; border: none; font-size: 0.7rem; font-weight: bold; cursor: pointer; }
        .water-fill { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: var(--dark-blue); transition: width 1s linear; z-index: 1; }
        
        .add-plant-btn { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 30px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 200; cursor: pointer; }
        
        .lock-status { font-size: 0.7rem; color: #888; margin-left: 5px; font-weight: normal; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-top">
            <h1>ðŸŒ¿ Logan's Garden <span id="lock-label" class="lock-status">(ðŸ”’ Locked)</span></h1>
            <div id="status">Ready</div>
        </div>
        <div class="filter-row">
            <input type="text" id="search-bar" placeholder="Search plants..." oninput="filterList()">
            <select id="room-filter" onchange="filterList()"><option value="">All Rooms</option></select>
        </div>
    </div>
    <div id="plant-list"></div>
</div>

<button class="add-plant-btn" onclick="addNewPlant()">+ Add New Plant</button>

<script>
    const SUPABASE_URL = 'https://hnznwbklfoiolptvvypf.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_qIZadFFd7xDvVjxGsTnNQQ_NmuTJhPV';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allPlants = [];
    let waterTimer, holdTimer, syncTimer;
    let isAuthenticated = false; // Tracks session unlock

    async function loadData() {
        const { data } = await _supabase.from('plants').select('*');
        allPlants = data || [];
        updateRoomDropdown();
        renderAll();
    }

    // --- SECURITY LOGIC ---
    async function checkAuth() {
        if (isAuthenticated) return true;
        const pwd = prompt("Enter password to unlock changes:");
        if (!pwd) return false;

        const { data } = await _supabase.from('app_settings').select('value').eq('key', 'admin_password').single();
        
        if (data && data.value === pwd) {
            isAuthenticated = true;
            document.getElementById('lock-label').innerText = "(ðŸ”“ Unlocked)";
            document.getElementById('lock-label').style.color = "var(--primary)";
            return true;
        } else {
            alert("Incorrect password.");
            return false;
        }
    }

    function updateRoomDropdown() {
        const dropdown = document.getElementById('room-filter');
        const rooms = [...new Set(allPlants.map(p => p.location).filter(l => l))];
        dropdown.innerHTML = '<option value="">All Rooms</option>' + rooms.map(r => `<option value="${r}">${r}</option>`).join('');
    }

    function filterList() {
        const query = document.getElementById('search-bar').value.toLowerCase();
        const room = document.getElementById('room-filter').value;
        document.querySelectorAll('.plant-card').forEach(card => {
            const name = card.querySelector('.name-input').value.toLowerCase();
            const loc = card.querySelector('.location-input').value;
            card.style.display = (name.includes(query) && (!room || loc === room)) ? 'flex' : 'none';
        });
    }

    function getTrend(plant) {
        if (!plant.avg_water_interval) return { icon: '', class: '' };
        if (plant.avg_water_interval <= 5) return { icon: 'â†“â†“', class: 'trend-fast' };
        if (plant.avg_water_interval >= 10) return { icon: 'â†“', class: 'trend-slow' };
        return { icon: 'â†“', class: '' };
    }

    function calculateDynamicMoisture(plant) {
        if (!plant.watered_date) return plant.moisture_level || 5;
        const lastDate = plant.moisture_timestamp ? new Date(plant.moisture_timestamp) : new Date(plant.watered_date);
        const daysPassed = (new Date() - lastDate) / (1000 * 60 * 60 * 24);
        const interval = plant.avg_water_interval || 7;
        let level = (plant.moisture_level || 10) - (daysPassed * (10 / interval));
        return Math.max(1, Math.min(10, Math.round(level)));
    }

    function renderAll() {
        const list = document.getElementById('plant-list');
        list.innerHTML = '';
        allPlants.forEach(plant => {
            const id = plant.id;
            const currentLevel = calculateDynamicMoisture(plant);
            const trend = getTrend(plant);
            const card = document.createElement('div');
            card.className = `plant-card ${currentLevel <= 3 ? 'card-dry' : ''}`;
            card.innerHTML = `
                <input type="text" class="location-input" value="${plant.location || 'UNSET'}" oninput="queueSync('${id}', 'location', this.value)">
                <div class="card-top">
                    <div class="photo-box" onclick="triggerPhotoUpload('${id}')">
                        <input type="file" id="file-${id}" style="display:none" accept="image/*,.pdf" onchange="uploadPhoto('${id}', this)">
                        <img src="${plant.image_url || ''}" style="${plant.image_url ? 'display:block' : 'display:none'}">
                        <span class="photo-label" style="${plant.image_url ? 'display:none' : 'display:block'}">PHOTO</span>
                    </div>
                    <div>
                        <input type="text" class="name-input" value="${plant.name}" oninput="queueSync('${id}', 'name', this.value)">
                        <div class="moisture-wrap">
                            <div class="moisture-controls">
                                <div class="unlock-btn" onmousedown="startHold('${id}')" ontouchstart="startHold('${id}')">ðŸ”’</div>
                                <input type="range" id="gauge-${id}" class="gauge-slider" min="1" max="10" value="${currentLevel}" oninput="updateUI('${id}', this.value)" onchange="manualEntry('${id}', this.value)">
                                <span id="val-${id}" style="font-weight:bold;">${currentLevel}</span>
                                <span class="trend-icon ${trend.class}">${trend.icon}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <span class="badge-ai">AI Cycle: ${plant.avg_water_interval || '?'} days</span>
                    <div class="water-btn-wrap">
                        <div id="fill-${id}" class="water-fill"></div>
                        <button class="water-btn" onmousedown="startWater('${id}')" ontouchstart="startWater('${id}')">ðŸ’§ HOLD TO WATER</button>
                    </div>
                </div>
            `;
            list.appendChild(card);
            updateUI(id, currentLevel);
        });
        filterList();
    }

    async function triggerPhotoUpload(id) {
        if (!(await checkAuth())) return;
        document.getElementById(`file-${id}`).click();
    }

    async function uploadPhoto(id, input) {
        const file = input.files[0];
        if (!file) return;
        updateStatus("Uploading...", "saving");
        const fileName = `${id}-${Date.now()}.png`;
        const { error } = await _supabase.storage.from('plant-photos').upload(fileName, file);
        if (!error) {
            const { data: urlData } = _supabase.storage.from('plant-photos').getPublicUrl(fileName);
            await _supabase.from('plants').update({ image_url: urlData.publicUrl }).eq('id', id);
            loadData();
            updateStatus("Photo Saved", "saved");
        }
    }

    async function manualEntry(id, val) {
        if (!(await checkAuth())) { loadData(); return; }
        const plant = allPlants.find(p => p.id === id);
        if (plant.watered_date) {
            const days = (new Date() - new Date(plant.watered_date)) / (1000 * 60 * 60 * 24);
            const points = 10 - val;
            if (points > 0) {
                const implied = (days * 10) / points;
                plant.avg_water_interval = Math.round(((plant.avg_water_interval || implied) + implied) / 2);
            }
        }
        await _supabase.from('plants').update({ 
            moisture_level: parseInt(val), 
            moisture_timestamp: new Date().toISOString(),
            avg_water_interval: plant.avg_water_interval 
        }).eq('id', id);
        loadData();
    }

    async function startWater(id) {
        if (!(await checkAuth())) return;
        document.getElementById(`fill-${id}`).style.width = '100%';
        waterTimer = setTimeout(async () => {
            const today = new Date().toISOString().split('T')[0];
            const plant = allPlants.find(p => p.id === id);
            if (plant.watered_date) {
                const actual = Math.ceil((new Date(today) - new Date(plant.watered_date)) / (1000 * 60 * 60 * 24));
                plant.avg_water_interval = plant.avg_water_interval ? Math.round((plant.avg_water_interval + actual) / 2) : actual;
            }
            await _supabase.from('plants').update({ 
                watered_date: today, moisture_level: 10, 
                moisture_timestamp: new Date().toISOString(),
                avg_water_interval: plant.avg_water_interval
            }).eq('id', id);
            loadData();
        }, 1000);
    }

    async function queueSync(id, col, val) {
        if (!isAuthenticated && !(await checkAuth())) { loadData(); return; }
        updateStatus("Saving...", "saving");
        clearTimeout(syncTimer);
        syncTimer = setTimeout(async () => {
            await _supabase.from('plants').update({ [col]: val }).eq('id', id);
            if (col === 'location') updateRoomDropdown();
            updateStatus("Saved", "saved");
        }, 1000);
    }

    async function addNewPlant() {
        if (!(await checkAuth())) return;
        const n = prompt("Plant Name:");
        if (n) {
            await _supabase.from('plants').insert([{ name: n, moisture_level: 10, watered_date: new Date().toISOString().split('T')[0] }]);
            loadData();
        }
    }

    function updateUI(id, val) {
        const v = document.getElementById(`val-${id}`);
        const g = document.getElementById(`gauge-${id}`);
        v.innerText = val;
        let color = val >= 8 ? 'var(--gauge-blue)' : (val >= 4 ? 'var(--gauge-green)' : 'var(--gauge-red)');
        v.style.color = color;
        g.style.background = `linear-gradient(to right, ${color} ${val * 10}%, #ddd ${val * 10}%)`;
    }

    function updateStatus(t, c) { const s = document.getElementById('status'); s.innerText = t; s.className = c ? 'status-'+c : ''; }
    function startHold(id) { holdTimer = setTimeout(() => { document.getElementById(`gauge-${id}`).classList.add('unlocked'); }, 800); }
    loadData();
</script>
</body>
</html>
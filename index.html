<script>
    // ... (SUPABASE CONFIG & AUTH REMAINS SAME)

    function renderAll() {
        const list = document.getElementById('plant-list');
        list.innerHTML = '';
        allPlants.sort((a,b) => a.name.localeCompare(b.name)).forEach(plant => {
            const id = plant.id;
            const currentLevel = calculateDynamicMoisture(plant);
            const activity = getActivityData(plant);
            const checkTime = getTimeData(plant.moisture_timestamp || plant.watered_date);
            const trend = currentTrend[id] || { arrow: '‚Üí', theme: 'cycle-stable' };
            
            // ALERT LOGIC: Updated to 25% threshold
            let alertsHtml = '';
            const cycleDays = plant.avg_water_interval || 7;
            
            if (currentLevel <= 3) {
                alertsHtml += `<span class="badge" style="background:var(--alert-red); color:white; border-color:#c0392b;">üíß WATER NOW</span>`;
            }
            
            // Trigger ‚öñÔ∏è if last manual touch/sip/soak is older than 25% of the cycle
            if (checkTime.days > (cycleDays * 0.25)) {
                alertsHtml += `<span class="badge" style="background:#555; color:white; border-color:#333;">‚öñÔ∏è CHECK MOISTURE</span>`;
            }

            const card = document.createElement('div');
            card.className = 'plant-card';
            card.innerHTML = `
                <div class="card-top">
                    <div class="photo-box" onclick="handlePhotoClick('${id}')">
                        <img src="${plant.image_url || ''}" style="${plant.image_url ? 'display:block' : 'display:none'}">
                        <span style="font-size:1.5rem; color:#a8c6a8; font-weight:bold;">+</span>
                    </div>
                    <input type="file" id="file-${id}" style="display:none" accept="image/*,application/pdf" onchange="uploadPhoto('${id}', this)">
                    <div class="name-area">
                        <div class="name-label" style="font-weight:bold; font-size:1.1rem;">${plant.name}</div>
                        <div class="badge-row">
                            <span class="badge ${trend.theme}">Cycle: ${Math.round(cycleDays)}d ${trend.arrow}</span>
                            ${alertsHtml}
                        </div>
                        <div class="badge-row" style="margin-top:2px; opacity:0.8;">
                            <span class="badge badge-water">${activity.label}</span>
                        </div>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:5px;">
                    <span style="font-size:0.6rem; font-weight:800; color:#999">PREDICTED LEVEL</span>
                    <span id="val-${id}" style="font-size:1.6rem; font-weight:900;">${currentLevel}</span>
                </div>

                <div class="moisture-wrap">
                    <div id="shield-${id}" class="input-shield" onclick="unlockControls('${id}')"></div>
                    <div class="moisture-controls">
                        <button id="minus-${id}" class="step-btn" onclick="stepMoisture('${id}', -1)">‚àí</button>
                        <input type="range" id="gauge-${id}" class="gauge-slider" min="1" max="10" value="${currentLevel}" oninput="updateUI('${id}', this.value)" onchange="manualEntry('${id}', this.value)">
                        <button id="plus-${id}" class="step-btn" onclick="stepMoisture('${id}', 1)">+</button>
                    </div>
                </div>

                <div class="action-group">
                    <div class="hold-btn-wrap" style="border:1px solid var(--sip-orange)" onmousedown="startHold('${id}', 'sip', 2000)" ontouchstart="startHold('${id}', 'sip', 2000)" onmouseup="endHold()" ontouchend="endHold()">
                        <div id="sipfill-${id}" class="hold-fill" style="background:var(--sip-orange)"></div>
                        <div class="hold-label">SIP (2s)</div>
                    </div>
                    <div class="hold-btn-wrap" style="border:1px solid var(--blue)" onmousedown="startHold('${id}', 'soak', 4000)" ontouchstart="startHold('${id}', 'soak', 4000)" onmouseup="endHold()" ontouchend="endHold()">
                        <div id="soakfill-${id}" class="hold-fill" style="background:var(--blue)"></div>
                        <div class="hold-label">SOAK (4s)</div>
                    </div>
                </div>
            `;
            list.appendChild(card);
            updateUI(id, currentLevel);
        });
    }
    // ... (REST OF UTILITIES)
</script>